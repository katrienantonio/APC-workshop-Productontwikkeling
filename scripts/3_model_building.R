## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#install.packages("tidyverse")
#install.packages("AmesHousing")
#install.packages("rstudioapi")
#install.packages("here")
library(tidyverse)
library(AmesHousing)
library(rstudioapi)

## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(dir)
mtpl_orig <- read.table('../data/PC_data.txt',
                        header = TRUE)
mtpl_orig <- as_tibble(mtpl_orig)

mtpl <- mtpl_orig %>%
  # rename all columns 
  rename_all(function(.name) {
    .name %>% 
      # replace all names with the lowercase versions
      tolower 
    # replace all spaces with underscores is also useful, with `str_replace(" ", "-")`
  })
mtpl <- rename(mtpl, expo = exp)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ames <- AmesHousing::make_ames()


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model_1 <- lm(Sale_Price ~ Gr_Liv_Area, data = ames)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model_1 <- lm(Sale_Price ~ Gr_Liv_Area, data = ames)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(model_1)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model_1$coefficients


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
coef(model_1)

## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(model_1)$coefficients


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
head(model_1$fitted.values)


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(model_1)$r.squared


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model_1 %>% broom::tidy()


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model_1 %>% broom::glance()


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model_1 %>% broom::augment() %>% slice(1:5)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
g_lm_1 <- ggplot(data = ames, aes(Gr_Liv_Area, Sale_Price)) + theme_bw() +
  geom_point(size = 1, alpha = 0.3) +
  geom_smooth(se = TRUE, method = "lm") +
  scale_y_continuous(labels = scales::dollar) +
  ggtitle("Regression with AMES housing data")
g_lm_1


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model_1 %>% broom::augment() %>% ggplot(aes(Gr_Liv_Area, Sale_Price)) + 
  theme_bw() +
  geom_point(size = 1, alpha = 0.3) +
  geom_line(aes(y = .fitted), col = KULbg) +
  scale_y_continuous(labels = scales::dollar) +
  ggtitle("Regression with AMES housing data")


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
g_freq <- ggplot(mtpl, aes(nclaims)) + theme_bw() + 
  geom_bar(aes(weight = expo), col = KULbg, 
           fill = KULbg, alpha = .5) + 
  labs(y = "Abs freq (in exposure)") +
  ggtitle("MTPL - number of claims")
g_freq


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
g_sev <- ggplot(mtpl, aes(x = avg)) + theme_bw() +
  geom_histogram(bins = 30, boundary = 0, color = KULbg, fill = KULbg, alpha = .5) + 
  labs(x = "claim severity") +
  xlim(c(0, 20000))
g_sev


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
freq_by_gender <- mtpl %>% 
  group_by(sex) %>% 
  summarize(emp_freq = sum(nclaims) / sum(expo)) 
freq_by_gender 


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(freq_by_gender, aes(x = sex, y = emp_freq)) + theme_bw() +
  geom_bar(stat = "identity", col = KULbg, fill = KULbg, alpha = .5)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
freq_glm_1 <- glm(nclaims ~ sex, offset = log(expo), 
                  family = poisson(link = "log"), 
                  data = mtpl)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
summary(freq_glm_1)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
freq_glm_1 %>% broom::tidy() 


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
freq_glm_1 %>% broom::glance() 


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
freq_glm_2 <- glm(nclaims ~ sex + coverage + use + fuel + fleet, offset = log(expo), 
                  family = poisson(link = "log"), 
                  data = mtpl)
anova(freq_glm_2)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
predict(freq_glm_1, type = "response")[1:4]


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
resid(freq_glm_1, type = "deviance")[1:4]


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
freq_glm_1 %>% broom::augment(type.predict = "response") %>% slice(1:2) %>% select(nclaims, sex, .fitted, .resid) 


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
exp(coef(freq_glm_1)[1])
exp(coef(freq_glm_1)[1] + coef(freq_glm_1)[2])


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------




## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
