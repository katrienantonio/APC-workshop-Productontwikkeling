## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#install.packages("tidyverse")
#install.packages("AmesHousing")
#install.packages("rstudioapi")
#install.packages("here")
library(tidyverse)
library(AmesHousing)
library(rstudioapi)

dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
setwd(dir)

invalidering <- read.csv('../data/invalidering landelijke data 2019.csv', 
                         header = TRUE, sep = ";")
revalidering <- read.csv('../data/revalidering landelijke data 2019.csv', 
                         header = TRUE, sep = ";")


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
invalidering <- as_tibble(invalidering)
invalidering <- invalidering %>% rename(jaar = Beschouwd.Jaar, beroep = Beroepsklasse, 
                                        leeft_kl = Leeftijdsklasse, aant_val = Aantal.validen, 
                                        verz_rente = Verzekerde.rente.in.euro.s, 
                                        som_uitk_perc = Som.uitkeringspercentage.met.ziektedatum.in.de.eerste.9.maanden.van.jaar.t)


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
str(invalidering) 


## -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
unique(invalidering$jaar)
unique(invalidering$beroep)
unique(invalidering$leeft_kl)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
invalidering %>% distinct(jaar) 


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
invalidering <- invalidering %>% mutate(beroep = as.factor(beroep), 
                                        leeft_kl = as.factor(leeft_kl))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
invalidering <- invalidering %>% mutate(leeft_kl = fct_recode(leeft_kl, "61 tm 65" = "61 tot 65"))


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
invalidering <- mutate(invalidering, 
                       inv_probs = som_uitk_perc/aant_val/100)


## ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(invalidering) + geom_line(aes(x = jaar, y = inv_probs, color = leeft_kl)) + 
  facet_wrap( ~ beroep, ncol = 3) + theme_bw()


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
invalidering <- invalidering %>% mutate(jaar_fct = as.factor(jaar))
ggplot(invalidering) + 
  geom_line(aes(x = leeft_kl, y = inv_probs, 
                color = jaar_fct, group = jaar_fct)) + 
  facet_wrap( ~ beroep, ncol = 3) + theme_bw() 


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
inv_leeft_kl <- invalidering %>% 
  group_by(leeft_kl, jaar_fct) %>% 
  summarize(tot_val = sum(aant_val), 
            tot_perc = sum(som_uitk_perc))
inv_leeft_kl <- mutate(inv_leeft_kl, 
                       inv_probs = tot_perc/tot_val/100)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(inv_leeft_kl, aes(x = leeft_kl, y = inv_probs, 
                         color = jaar_fct, group = jaar_fct)) + 
  geom_point() + geom_line() + theme_bw()


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
polis <- read.csv('../data/polissen verzekeraar ABC 2019.csv', 
                  header = TRUE, sep = ";", dec = ",")


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
polis <- as_tibble(polis)
polis <- polis %>% rename(verz_rente = Verzekerde.rente, wcht_dagen = wachttijd.in.dagen, 
                          drie_mnd_inv = minstens.3.mnd.invalide)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
polis <- polis %>%
  # rename all columns 
  rename_all(function(.name) {
    .name %>% 
      # replace all names with the lowercase versions
      tolower 
  })


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
str(polis) 


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
schade <- read.csv('../data/schades verzekeraar ABC 2019.csv', 
                   header = TRUE, sep = ";", dec = ",")


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
schade <- as_tibble(schade)
schade <- schade %>% rename(verz_rente = verz.rente, uitk_perc = uitkeringspercentage, 
                            wcht_dagen = wachttijd.in.dagen, 
                            ing_datum = Ingangsdatum.uitkering.behorende.bij.schadejaar)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
schade <- schade %>%
  # rename all columns 
  rename_all(function(.name) {
    .name %>% 
      # replace all names with the lowercase versions
      tolower 
  })


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
str(schade) 


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
unique(polis$jaar)
unique(schade$jaar)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
polis <- polis %>% arrange(index, jaar)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
schade <- schade %>% arrange(index, schadejaar, jaar)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 polis %>%
   group_by(index, jaar) %>%
   filter(n() > 1)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
schade %>%
   group_by(index, schadejaar, jaar) %>%
   filter(n() > 1)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
schade <- schade %>% 
  mutate(dev_jaar = jaar - ing_datum + 1)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
schade_unique <- schade %>% group_by(index, schadejaar) %>% filter(row_number() == 1)
schade_unique <- unique(schade_unique$index)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
polis_unique <- unique(polis$index)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
length(which(! schade_unique %in% polis_unique))


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
schade <- schade %>% group_by(index, schadejaar) %>% mutate(first_occ = ifelse(row_number() == 1, 1, 0), 
                                                last_occ = ifelse(row_number() == n(), 1, 0))


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
verz_by_leeft <- polis %>% 
  group_by(leeftijd) %>% 
  summarize(tot_rente = sum(verz_rente), 
            tot_obs = n(), 
            tot_duur= sum(duur),
            tot_inv = sum(drie_mnd_inv),
            rel_dis = sum(drie_mnd_inv)/tot_obs,
            avg_rente = tot_rente/tot_obs)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(verz_by_leeft, aes(x = leeftijd, y = tot_rente)) + theme_bw() +
  geom_bar(stat = "identity", color = KULbg, fill = KULbg, alpha = 0.5) +
  ggtitle("Polis - tot verz rente per leeftijd")



## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
verz_by_geslacht <- polis %>% 
  group_by(geslacht) %>% 
  summarize(tot_rente = sum(verz_rente), 
            tot_obs = n(), 
            tot_duur= sum(duur),
            tot_inv = sum(drie_mnd_inv),
            rel_dis = sum(drie_mnd_inv)/tot_obs,
            avg_rente = tot_rente/tot_obs) %>%
  mutate(freq = prop.table(tot_obs))



## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(verz_by_geslacht, 
       aes(x = geslacht, y = tot_rente)) + 
  theme_bw() +
  geom_bar(stat = "identity", color = KULbg, 
           fill = KULbg, alpha = 0.5) +
  ggtitle("Polis - tot verz rente per geslacht")


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
verz_by_beroep <- polis %>% 
  group_by(beroep) %>% 
  summarize(tot_rente = sum(verz_rente), 
            tot_obs = n(), 
            tot_duur= sum(duur),
            tot_inv = sum(drie_mnd_inv),
            rel_dis = sum(drie_mnd_inv)/tot_obs,
            avg_rente = tot_rente/tot_obs) %>%
  mutate(freq = prop.table(tot_obs))


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(verz_by_beroep, 
       aes(x = beroep, y = tot_rente)) + 
  theme_bw() +
  geom_bar(stat = "identity", color = KULbg, 
           fill = KULbg, alpha = 0.5) +
  ggtitle("Polis - tot verz rente per beroepsklasse")


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
leeft_breaks <- c(15, 25, 30, 35, 40, 45, 50, 55, 60, 65)
leeft_labels <- unique(invalidering$leeft_kl)
polis <- polis %>% mutate(leeftijd_fct = cut(leeftijd, breaks = leeft_breaks, labels = leeft_labels))


## -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
polis_select <- polis %>% filter(jaar > 2004)
schade_select <- schade %>% 
  select(index, uitk_perc, jaar, schadejaar, 
         ing_datum, dev_jaar, first_occ, last_occ)


## --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
test <- left_join(polis_select, schade_select, by = c("index" = "index", "jaar" = "jaar"))
